## 2024-07-30 - 技术设计阶段：引入 Supabase 与整体架构图

**背景**: 用户进入技术设计阶段，并明确项目将采用 Supabase 进行部署，要求将登录、身份认证、存储等核心功能调整为基于 Supabase 的实现。同时，需要绘制一份整体架构图以促进团队协作。

**决策**:
1.  **核心后端服务**：选择 Supabase 作为主要的后端即服务 (BaaS) 平台，用于用户身份认证 (Supabase Auth)、数据库 (PostgreSQL)、文件存储 (Supabase Storage)。
2.  **API 网关**：前端与后端服务之间通过 API Gateway 进行通信，可使用 Supabase Edge Functions 或 Vercel Functions。
3.  **算法服务独立性**：AI 相关的核心算法（用户画像分析、运势推算、对话理解与生成、合盘分析）将作为独立的微服务部署，通过 RESTful API 与 API Gateway 交互，保持与研发侧的职责分离。
4.  **认证方式优化**：身份认证、登录注册将优先以 Supabase 最佳实现方式为准，例如，若手机号、邮箱实现复杂，则直接使用 Apple/Google 关联登录等方式。

**实施**:
1.  **文件修改**: 更新 `docs/technical/phase1_tech_design.md`，详细说明 Supabase 在用户身份认证、账号管理和数据存储方面的应用。
2.  **架构设计**: 提供了 Aura 系统的整体架构文本描述，清晰地划分了前端、后端、算法服务和外部服务的功能边界和交互流程。

**结果**:
明确了 Aura 项目的技术栈方向，特别是对 Supabase 的依赖，为后续的研发工作提供了清晰的指引。整体架构的文本描述有助于团队成员对系统全貌的理解，促进跨团队协作。未来在实现身份认证时，将优先考虑 Supabase 的便捷性。

---

## 2024-07-30 - 技术设计阶段：算法服务细节更新

**背景**: 用户对算法服务提供了更详细的说明，指出算法服务内部会有一套自己的记忆系统，以类似 Agent 的结构调用 LLM 接口进行处理，且不涉及 GPU 实例。

**决策**:
1.  **更新算法服务描述**：在 `docs/technical/system_architecture.md` 中补充算法服务的具体实现细节，包括其内部记忆系统、基于 LLM 的 Agent 结构以及对 GPU 资源的非依赖性。

**实施**:
1.  **文件修改**: 成功更新 `docs/technical/system_architecture.md`。

**结果**:
技术设计文档中关于算法服务的描述更加准确和完善，有助于研发和算法团队之间更清晰的理解和协作。强调不涉及 GPU 实例有助于优化部署和资源规划。

---

## 2024-07-30 - 技术设计阶段：优化整体架构图

**背景**: 用户对整体架构图的布局和数据流表示存在优化需求，希望图表更美观、信息更清晰，并明确 Supabase 数据库数据服务会被算法服务使用。

**决策**:
1.  **架构图布局优化**：将 Mermaid 图的布局方向从 `TD` (Top-Down) 调整为 `LR` (Left-Right)，以期实现各主要组件的平均分布和视觉美观。
2.  **数据流明确化**：在架构图中添加从 Supabase Database 到算法服务的数据读写连接，清晰表示算法服务对数据库的依赖。

**实施**:
1.  **文件修改**: 成功更新 `docs/technical/system_architecture.md` 中的 Mermaid 架构图语法。

**结果**:
更新后的系统架构图在视觉上更均衡，并明确了 Supabase Database 与算法服务之间的数据交互，进一步提升了文档的清晰度和可理解性。

---

## 2024-07-30 - 技术设计阶段：功能实现细节与职责边界澄清

**背景**: 用户对当前架构中某些功能的具体实现方式提出疑问，特别是新手引导、对话能力和合盘功能如何与算法服务交互，并质疑是否所有功能都直接放到算法服务。

**决策**:
1.  **澄清研发与算法交互模式**：明确研发团队在 API Gateway 层会进行必要的处理（用户认证、数据持久化到 Supabase），然后根据业务逻辑调用相应的算法接口，并存储算法返回的结果，而非简单转发。
2.  **详细说明功能实现流**：
    *   **新手引导**：前端收集信息 -> API Gateway 调用 Supabase Auth/Database 持久化用户 Profile -> API Gateway 调用算法 `user-profile-analysis` -> 存储算法结果。
    *   **对话能力**：前端与 API Gateway 实时连接 -> API Gateway 持久化对话记录 -> API Gateway 调用算法 `chat/respond` -> 接收算法回复并持久化 -> 发送回复给前端。
    *   **合盘功能**：前端输入他人信息 -> API Gateway 持久化他人 Profile -> API Gateway 调用算法 `compatibility/calculate` -> 存储算法结果。

**实施**:
1.  **交互内容记录**: 将上述详细的功能实现流程和职责划分说明记录在此文件中，以提供清晰的上下文。

**结果**:
详细阐明了研发与算法团队在具体功能实现中的协作模式和职责边界，解决了用户关于功能实现方式的疑问，使得系统设计更加清晰和可操作。 

## [日期时间] - 重构技术设计文档以分离接口、功能和数据库表设计

**背景**: 用户希望将 `phase1_tech_design.md` 文档中的接口、功能和数据库表设计分开记录，以提高文档的清晰度和可读性，便于算法团队查阅和开发。

**决策**: 决定重构 `phase1_tech_design.md`，引入新的顶级章节 `3. 数据库表设计` 和 `4. 算法接口设计`。原有的功能章节（`2.1 用户身份认证与账号管理` 等）将只保留研发任务描述，并引用新的章节中的详细定义。

**实施**:
- 将 `phase1_tech_design.md` 中所有数据库表结构定义（`profiles`, `avatars`, `user_profiles_analysis`, `chat_sessions`, `chat_messages`, `daily_fortunes`, `other_profiles`, `compatibility_analysis_results`, `pricing_plans`, `transactions`, `user_subscriptions`）移动到 `3. 数据库表设计` 章节下。
- 将所有算法接口的请求参数和响应示例移动到 `4. 算法接口设计` 章节下。
- 更新 `2. 详细设计任务分解` 中的各个子章节，使其引用新的数据库表设计和算法接口设计章节。

**结果**: `phase1_tech_design.md` 文档结构变得更加清晰，数据库表设计、算法接口设计与功能描述分离，便于算法团队独立进行开发，并提高文档的可维护性。 

## [日期时间] - 完善技术设计文档的协作流程描述

**背景**: 用户希望在 `phase1_tech_design.md` 的第一章节中，补充关于前端请求如何流转、研发团队与算法团队服务之间如何协作的简要介绍，以便更清晰地理解系统工作机制。

**决策**: 在 `1.2 研发与算法职责划分` 之后新增一个 `1.3 服务协作流程` 小节，描述前端请求通过 API Gateway 路由至算法服务，以及算法服务处理完成后返回结果的流程，明确研发和算法团队的协作边界。

**实施**:
- 在 `docs/technical/phase1_tech_design.md` 文件中，于 `1.2 研发与算法职责划分` 小节后插入 `1.3 服务协作流程` 小节，并添加相应的描述内容。

**结果**: `phase1_tech_design.md` 文档的概述部分更加完善，清晰地阐述了研发与算法团队在请求处理流程中的协作方式，提高了文档的易读性和指导性。

---

## [2025-08-04] - 技术架构重大调整：引入阿里云 SAE + FastAPI BFF

**背景**: 根据新的业务架构图，原有基于 Supabase Edge Functions 的简单网关方案无法满足日益复杂的业务逻辑需求。业务逻辑越来越复杂，需要一个更强大的后端服务层来处理业务编排、数据聚合和服务调用。

**决策**: 
1. **架构重新设计**：从 Supabase 为中心的架构调整为阿里云 Serverless + Supabase 的混合架构
2. **服务分层**：
   - **负载均衡层**：阿里云 SAE 内置网关/SLB 作为统一 HTTPS 入口
   - **业务逻辑层**：FastAPI BFF (Backend For Frontend) 服务，负责业务编排、数据聚合、服务调用
   - **AI 计算层**：独立的 AI 服务，部署为 SAE 应用或函数计算
   - **基础服务层**：Supabase 专注于提供认证、数据库、存储等基础设施
3. **部署平台**：全面采用阿里云 Serverless 应用引擎 (SAE) 进行应用部署
4. **角色重新定位**：Supabase 从核心服务变为 BaaS 基础设施提供商

**实施**:
1. **更新系统架构文档** (`system_architecture.md`)：
   - 重新绘制架构图，体现新的分层结构
   - 更新各组件职责描述，明确 FastAPI BFF 的核心作用
   - 调整数据流和交互模式描述
2. **更新部署策略文档** (`deployment_strategy.md`)：
   - 加入阿里云 SAE 部署策略
   - 设计 CI/CD 自动化流程
   - 配置不同环境的资源分配策略
3. **更新技术设计文档** (`phase1_tech_design.md`)：
   - 将 API Gateway 表述调整为 FastAPI BFF 服务
   - 强调 BFF 的业务编排和数据聚合能力

**结果**: 
- 建立了更加清晰和强大的分层架构，各层职责明确
- FastAPI BFF 层为复杂业务逻辑提供了合适的处理平台
- Supabase 专注于其擅长的基础设施服务，避免过度复杂化
- 阿里云 SAE 提供了更好的扩展性和运维管理能力
- 为未来的业务增长和功能扩展奠定了坚实的架构基础 